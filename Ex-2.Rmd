---
title: "Ex-2"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r}
rm(list=ls())
setwd("D:/Fileslala/QSS with R/Chap2")

```

# Small calss size in the early education

### 1.re-distribute the variables
```{r}
# preparing data
educ <- read.csv("STAR.csv")
educ$kinder = ifelse(educ$classtype %in% c(1), "small", 
                     ifelse(educ$classtype == 2, 
                            "regular", "regular with aid"))

educ$race_4l = ifelse(educ$race %in% c(3,6), "others",
                      ifelse(educ$race %in% c(1), "white",
                             ifelse(educ$race == 2, "black", "hispanic")))

```

### 2. comapring the grades
```{r}
tapply(educ$g4reading, educ$kinder, mean, na.rm=TRUE) -
  mean(educ$g4reading[educ$kinder=="small"], na.rm=TRUE)


tapply(educ$g4reading, educ$kinder, sd, na.rm=TRUE)
tapply(educ$g4math, educ$kinder, sd, na.rm=TRUE)

```
For performance of reading test, the average score of small-class students is 3.5 higher than the regular-sized class students. And the deviance of small class students from average is smaller. For performance on math, there is no obvious difference between small-class students and regular-sized students. And small class somehow increase the deviance of students scores from the average.

### 3. Quantiles
```{r}
#reading
quantile(educ$g4reading[educ$kinder=="small"], probs=seq(0.33, 0.66, 0.33), na.rm=TRUE)
quantile(educ$g4reading[educ$kinder=="regular"], probs=seq(0.33, 0.66, 0.33), na.rm=TRUE)


#math
quantile(educ$g4math[educ$kinder=="small"], probs=seq(0.33, 0.66, 0.33), na.rm=TRUE)
quantile(educ$g4math[educ$kinder=="regular"], probs=seq(0.33, 0.66, 0.33), na.rm=TRUE)


### more concise code


# tapply(educ$g4reading, educ$kinder, quantile, probs=seq(0.33, 0.66, 0.33), na.rm=TRUE) - 
#  quantile(educ$g4reading[educ$kinder=="regular"], probs=seq(0.33, 0.66, 0.33), na.rm=TRUE)


```
Small class improve the high score while does no difference to low score in terms of reading grades. As for math, small class also improve the high score but also decrease the low score. 

### 4. Years of small class
```{r}
educ.kinder.year <- table(classtype = educ$kinder, Year = educ$yearssmall)
educ.kinder.year
addmargins(educ.kinder.year)

tapply(educ$g4reading, educ$yearssmall, mean, na.rm=TRUE)
tapply(educ$g4reading, educ$yearssmall, median, na.rm=TRUE)
tapply(educ$g4math, educ$yearssmall, mean, na.rm=TRUE)
tapply(educ$g4math, educ$yearssmall, median, na.rm=TRUE)

```
### 5. STAR reduces gaps
```{r}
regular<- subset(educ, kinder == "regular")
small <- subset(educ, kinder == "small")

tapply(regular$g4reading, regular$race_4l, mean, na.rm=TRUE)
tapply(small$g4reading, small$race_4l, mean, na.rm=TRUE)

cat("\n")

tapply(regular$g4math, regular$race_4l, mean, na.rm=TRUE)
tapply(small$g4math, small$race_4l, mean, na.rm=TRUE)


```
STAR program has an obvious boost for black students' reading grades, but it does little difference to black students' math grades. For other races students like Asian and indigenous students, STAR program clearly improve their reading and math grades.  

### 6. High school graduate
```{r}

tapply(educ$hsgrad, educ$kinder, mean, na.rm=TRUE)
tapply(educ$hsgrad, educ$yearssmall, mean, na.rm=TRUE)

cat("\n")
tapply(regular$hsgrad, regular$race_4l, mean, na.rm=TRUE)
tapply(small$hsgrad, small$race_4l, mean, na.rm=TRUE)

```
Small class and regular-sized class with aid have a higher high-school graduation rate.
More years of participating in small class seems to have a positive influence on high-school graduation rate.


# Gay Marriage
preparing data
```{r}
gmarriage <- read.csv("gay.csv")
head(gmarriage)
dim(gmarriage)
```

### 1. RCT
```{r}
study1_baseline <- subset(gmarriage, study==1 & wave==1)
tapply(study1_baseline$ssm, study1_baseline$treatment, mean, na.rm=TRUE)

```
Average scores of different scores are very close before treatment.

### 2. Treatment effect
```{r}
study1_w2 <- subset(gmarriage, study==1 & wave==2)

#calculate scores from different groups in wave1
base <- as.data.frame(tapply(study1_baseline$ssm, study1_baseline$treatment, mean, na.rm=TRUE))

#calculate scores from different groups in wave2
w2 <- as.data.frame(tapply(study1_w2$ssm, study1_w2$treatment, mean, na.rm=TRUE))

# calculate SATE
sate_gay <- w2[4, ] - w2[1, ]
sate_straight <- w2[5, ] - w2[1, ]

cat("GAY_SATE: ", sate_gay, "\n")
cat("Straight_SATE: ", sate_straight, "\n")

# OR using selection subset
# calculate gay SATE
mean(study1_w2$ssm[study1_w2$treatment == "Same-Sex Marriage Script by Gay Canvasser"]) - 
  mean(study1_w2$ssm[study1_w2$treatment == "No Contact"])

# calculate straight SATE
mean(study1_w2$ssm[study1_w2$treatment == "Same-Sex Marriage Script by Straight Canvasser"]) - 
  mean(study1_w2$ssm[study1_w2$treatment == "No Contact"])
  
```
### 3. Recycling
```{r}
gay_rec <- mean(study1_w2$ssm[study1_w2$treatment == "Same-Sex Marriage Script by Gay Canvasser"]) - mean(study1_w2$ssm[study1_w2$treatment == "Recycling Script by Gay Canvasser"])

cat("Difference between recycling script and same-sex script from gay canvassers: ", 
    gay_rec, "\n")

str_rec <- mean(study1_w2$ssm[study1_w2$treatment == "Same-Sex Marriage Script by Straight Canvasser"]) - mean(study1_w2$ssm[study1_w2$treatment == "Recycling Script by Straight Canvasser"])

cat("Difference between recycling script and same-sex script from straight canvassers:", str_rec, "\n")

```
It seems that straight canvassers have a stronger effect in influencing people's opinion on same-sex marriage. And the difference between SATE of no-contact and SATE of recycling script is not very significant.

### 4. Different waves

```{r}
# this one i did DiD

gmarriage_s1 <- subset(gmarriage, study==1)

for (i in 2:7){
  w1 <- as.data.frame(tapply(gmarriage_s1$ssm[gmarriage_s1$wave == i-1], gmarriage_s1$treatment[gmarriage_s1$wave == i-1], mean, na.rm=TRUE))
  w <- as.data.frame(tapply(gmarriage_s1$ssm[gmarriage_s1$wave == i], gmarriage_s1$treatment[gmarriage_s1$wave == i], mean, na.rm=TRUE))
    
  diff_gay <- (w[4, ] - w1[4, ]) - (w[1, ] - w1[1, ])
  diff_str <- (w[5, ] - w1[5, ]) - (w[1, ] - w1[1, ])
  
  cat("Difference of gay canvasser in Wave", i, ":", diff_gay, "\n")
  cat("Difference of straight canvasser in Wave", i, ":", diff_str, "\n", "\n")
  
}
```
```{r}

# this one i didn't do DiD

for (i in 1:7){
  w <- as.data.frame(tapply(gmarriage_s1$ssm[gmarriage_s1$wave == i], gmarriage_s1$treatment[gmarriage_s1$wave == i], mean, na.rm=TRUE))
    
  diff_gay <- w[4, ] - w[1, ]
  diff_str <- w[5, ] - w[1, ]
  
  cat("Difference of gay canvasser in Wave", i, ":", diff_gay, "\n")
  cat("Difference of straight canvasser in Wave", i, ":", diff_str, "\n", "\n")
  
}

```

It seems that canvassing still have positive effect even in the Wave7.

### 5. Study 2 RCT

```{r}
study2_baseline <- subset(gmarriage, study == 2 & wave == 1)
baseline_s2 <- as.data.frame(tapply(study2_baseline$ssm, study2_baseline$treatment, mean, na.rm=TRUE))
baseline_s2

```
The randomization has been done properly because the difference between treatment group and control group is not significant.

### 6. Study 2 ATE
```{r}
study2_w2 <- subset(gmarriage, study == 2 & wave == 2)
w2_s2 <- as.data.frame(tapply(study2_w2$ssm, study2_w2$treatment, mean, na.rm=TRUE))

# this is DiD
diff_gay <- (w2_s2[2, ] - baseline_s2[2, ]) - (w2_s2[1, ] - baseline_s2[1, ])
diff_gay

#Just SATE
cat("Wave1: ", sate_gay, "\n")
cat("Wave2: ", w2_s2[2, ] - w2_s2[1, ])

```
The ATE is higher in the Wave2.

### 7. Study 2 ATE in different times
```{r}

gmarriage_s2 <- subset(gmarriage, study==2)

# DiD
index <- c(1,2,3,4,7)

for (i in 1:4){
  w1 <- as.data.frame(tapply(gmarriage_s2$ssm[gmarriage_s2$wave == index[i]], gmarriage_s2$treatment[gmarriage_s2$wave == index[i]], mean, na.rm=TRUE))
  w <- as.data.frame(tapply(gmarriage_s2$ssm[gmarriage_s2$wave == index[i+1]], gmarriage_s2$treatment[gmarriage_s2$wave == index[i+1]], mean, na.rm=TRUE))
    
  diff_gay <- (w[2, ] - w1[2, ]) - (w[1, ] - w1[1, ])
  
  cat("Difference in difference for gay canvasser", index[i+1], "-", index[i], ":", diff_gay, "\n")

}

```
```{r}
# no DiD

for (i in 1:5){
  w <- as.data.frame(tapply(gmarriage_s2$ssm[gmarriage_s2$wave == index[i]], gmarriage_s2$treatment[gmarriage_s2$wave == index[i]], mean, na.rm=TRUE))
    
  diff_gay <- w[2, ] - w[1, ]

  cat("Difference of gay canvasser in Wave", index[i], ":", diff_gay, "\n")

}
```

# Success of leader assination
```{r}
leaders <- read.csv("leaders.csv")
head(leaders)
```
```{r}
names(leaders)

```
### 1. description
```{r}
length(unique(leaders$country))
dim(leaders)
```
```{r}
# average
length(leaders$year)/(max(leaders$year) - min(leaders$year))
```
250 attempts of assassination have been recorded in the datasheet, and 88 countries experienced at least one leader assassination attempt. All countries have nearly 2 attempts. 

```{r}
library(tidyverse)
```
```{r}
leaders$success <- ifelse(grepl("dies", c(leaders$result)), 1, 0
  
)

sum(leaders$success)/length(leaders$year)

```
The overall success rate of leader assassination is 21.6%. The randomly determination of successful assassination is not valid.

### 3. Average polity score
```{r}
# average polity score

before <- as.data.frame(tapply(leaders$politybefore, leaders$success, mean, na.rm=TRUE))
after <- as.data.frame(tapply(leaders$polityafter, leaders$success, mean, na.rm=TRUE))

diff_success <- after[2, ] - before[2, ]
diff_failed <- after[1, ] - before[1, ]

cat("Difference in successful assassination: ", diff_success, "\n")
cat("Difference in failed assassination: ", diff_failed, "\n")

# age difference
tapply(leaders$age, leaders$success, mean, na.rm=TRUE)

```
The average polity score of successful assassination attempts is relatively higher than the failed one. Leaders that was successfully assassinated have a higher average age than the those were survived.

### 4. Country in war
```{r}
leaders$warbefore <- ifelse(leaders$interwarbefore %in% c(1) |
                      leaders$civilwarbefore %in% c(1), 1, 0)

ass_war <- table(Success = leaders$success, War_experience = 
                   leaders$warbefore)

ass_war

tapply(leaders$success, leaders$warbefore, mean, na.rm=TRUE)
```
If a country have war experience prior to an assassination attempt, it will have lower success rate of assassination.

### 5. Results of assassination
```{r}

# democracy shift
demo_a <- as.data.frame(tapply(leaders$polityafter, leaders$success, mean, na.rm=TRUE))
demo_b <- as.data.frame(tapply(leaders$politybefore, leaders$success, mean, na.rm=TRUE))

cat("Difference in polity score when assassination succeeded: ", demo_a[2, ] - demo_b[2, ], "\n")

cat("Difference in polity score when assassination failed: ", demo_a[1, ] - demo_b[1, ], "\n")


# leads to war
leaders$warafter <- ifelse(leaders$interwarafter %in% c(1) |
                      leaders$civilwarafter %in% c(1), 1, 0)

success <- mean(leaders$warafter[leaders$success==1]) - 
  mean(leaders$warbefore[leaders$success==1])

failed <- mean(leaders$warafter[leaders$success==0]) - 
  mean(leaders$warbefore[leaders$success==0])

cat("Difference in war experience when assassination succeeded: ", 
    success, "\n")
cat("Difference in war experience when assassination failed: ", 
    failed, "\n")


```
Hypothesis 1: Successful assassination will leads to democratization.
Hypothesis 2: Successful assassination will leads to war.

From the analysis, successful assassination did improve the polity score on the average after the attempt. But given that the polity score is a 21 point scale, I do not think it is significant to say successful assassination can promote democratization. As for war experience, the rate of countries that have war experience after a successful attempt does show a significant drop by 14% comparing to the rate of previous years. But failed assassination also leads to 7% drop. Based on the previous conclusion that the dataset failed in the validity of randomly determined successful rate of assassination, the conclusion may also be biased. Because different countries may have different situation of international relations, thus leading to external invalidity.




